/*!
 * form.js 0.0.1
 * http://github.com/Elao/form.js
 * Copyright 2014 Elao and other contributors; Licensed MIT
 */

!function(a){function b(b){this.type=a.isArray(b)?"array":"object",this.elements="array"==this.type?[]:{},this.emitter=a(document.createElement("div")),this.onElementChange=this.onElementChange.bind(this),this.index(b)}function c(a){var b=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/;if("string"==typeof a)try{a="true"===a?!0:"false"===a?!1:"null"===a?null:+a+""===a?+a:b.test(a)?jQuery.parseJSON(a):a}catch(c){}return a}function d(b,c){this.element=a(b),this.replaceKey=new RegExp(this.element.data("collection"),"g"),this.currentKey=this.count(),this.allowAdd=!1,this.allowDelete=!1,this.min=!1,this.max=!1,this.limitMin=!1,this.limitMax=!1,this.htmlPrototype=null,this.addButton=null,this.items=null,this.clearData="undefined"==typeof c.clearData||c.clearData,this.onAdd="function"==typeof c.onAdd?c.onAdd:!1,this.onRemove="function"==typeof c.onRemove?c.onRemove:!1,this.parseAdd(c),this.parseDelete(c),this.parseMin(c),this.parseMax(c),this.parseItems(c),this.clearData&&this.element.removeAttr("data-collection"),this.element.data("collection",this)}function e(b,c){this.collection=b,this.element=a(c),this.deleteButton=null,this.parseDelete()}function f(b,c){this.element=a(b),this.expanded="select"!=this.element.prop("tagName").toLowerCase(),this.multiple=(this.expanded?a('input[type="checkbox"]',this.element).length:this.element.prop("multiple"))?!0:!1,this.choices=[],this.value=null;for(var d=this.element.children(),e=d.length,f=0;e>f;f++){var h=new g(d[f],this,"undefined"!=typeof c.data?c.data:null);""!==h.value&&null!==h.value&&this.choices.push(h)}this.element.on("change",this.updateValue.bind(this)),this.updateValue()}function g(b,d,e){this.element=a(b),this.parent=d,this.valueElement=this.parent.expanded?this.element.find('input[type="'+(this.parent.multiple?"checkbox":"radio")+'"]:first'):this.element,this.value=c(this.valueElement.val()),this.data="function"==typeof e?e.call(this):this.element.data()}b.prototype.index=function(a){if("array"==this.type)for(var b=element.length,c=0;b>c;c++)this.addElement(element[c],c);else for(var d in a)this.addElement(element[element],d)},b.prototype.addElement=function(b,c){"undefined"==typeof this.elements[c]&&(this.elements[c]=a(b),this.elements[c].on("change",this.onElementChange))},b.prototype.onElementChange=function(){this.parseData(),this.emitter.trigger("change")},b.prototype.parseData=function(){var a,b="array"==this.type?[]:{};if("array"==this.type)for(var d=this.elements.length,e=0;d>e;e++)a=c(this.elements[e].val()),null!==a&&""!==a&&(b[e]=a);else for(var f in this.elements)a=c(this.elements[f].val()),null!==a&&""!==a&&(b[f]=a);this.data=b},b.prototype.on=function(a,b){this.emitter.on(a,b)},b.prototype.off=function(a,b){this.emitter.off(a,b)},d.prototype.updateLimit=function(){if(!this.items)return!1;if(this.min){this.limitMin=this.count()<=this.min;for(var a=this.items.length-1;a>=0;a--)this.items[a].toggleDelete(!this.limitMin)}this.max&&(this.limitMax=this.count()>=this.max,this.addButton.toggle(!this.limitMax))},d.prototype.count=function(){return this.element.children().length},d.prototype.canAdd=function(a){return this.allowAdd&&!this.limitMax&&(this.onAdd?this.onAdd.call(this,a):!0)},d.prototype.canRemove=function(a){return this.allowDelete&&!this.limitMin&&(this.onRemove?this.onRemove.call(this,a):!0)},d.prototype.add=function(){var a=this.getPrototype();this.canAdd(a)&&(this.items.push(a),this.element.append(a.element),this.currentKey++,this.element.trigger("collection:added",[a]))},d.prototype.remove=function(a){var b=this.items.indexOf(a);b>=0&&this.canRemove()&&(this.items.splice(b,1),a.element.remove(),this.element.trigger("collection:deleted",[a]))},d.prototype.getPrototype=function(){return new e(this,this.htmlPrototype.replace(this.replaceKey,this.currentKey))},d.prototype.parseAdd=function(){var b=this.element.data("collection-add");this.htmlPrototype=this.element.data("prototype"),this.element.removeAttr("data-prototype"),b&&(this.allowAdd=!0,this.addButton=a("#"+b),this.addButton.on("click",this.add.bind(this)),this.clearData&&this.element.removeAttr("data-collection-add"))},d.prototype.parseDelete=function(){this.element.data("collection-delete")&&(this.allowDelete=!0,this.clearData&&this.element.removeAttr("data-collection-delete"))},d.prototype.parseMin=function(){var a=this.element.data("collection-min");a&&(this.min=a,this.element.on("collection:deleted",this.updateLimit.bind(this)),this.clearData&&this.element.removeAttr("data-collection-min"),this.updateLimit())},d.prototype.parseMax=function(){var a=this.element.data("collection-max");a&&(this.max=a,this.element.on("collection:added",this.updateLimit.bind(this)),this.clearData&&this.element.removeAttr("data-collection-max"),this.updateLimit())},d.prototype.parseItems=function(){if(!this.items){this.items=[];for(var a=this.element.children(),b=a.length,c=0;b>c;c++)this.items.push(new e(this,a[c]));this.updateLimit()}},e.prototype.remove=function(){this.collection.remove(this)},e.prototype.toggleDelete=function(a){this.deleteButton&&this.deleteButton.toggle(a)},e.prototype.parseDelete=function(){if(null===this.deleteButton){var b=a('[data-collection-delete="'+this.element[0].id+'"]',this.element);this.collection.allowDelete&&b&&(this.deleteButton=b,this.deleteButton.on("click",this.remove.bind(this)))}},f.prototype.matchers={},f.prototype.updateValue=function(){var a=this.getValueFromSelection();this.value!=a&&(this.value=a)},f.prototype.val=function(){return this.value},f.prototype.getValueFromSelection=function(){if(this.expanded){var b=this.getSelection();if(this.multiple){for(var d=b.length,e=[],f=0;d>f;f++)e.push(b[f].value);return e}return b.value}var g=this.element.val();return this.multiple?g?a.map(g,function(a){return c(a)}):[]:c(g)},f.prototype.getSelection=function(){for(var a,b=this.choices.length,c=[],d=0;b>d;d++)if(a=this.choices[d],a.isSelected()){if(!this.multiple)return a;c.push(a)}return c},f.prototype.filter=function(a,b){var c=this.choices.length;b=this.parseMatcher(b);for(var d=0;c>d;d++)this.choices[d].filter(a,b)},f.prototype.matchers.valueOptionMatcher=function(b,c){return a.isArray(b)?b.indexOf(c.value)>=0:b===c.value},f.prototype.parseMatcher=function(a){var b=typeof a;return"function"==b?a:"string"==b&&"undefined"!=typeof this.matchers[a]?this.matchers[a]:this.matchers.valueOptionMatcher},g.prototype.filter=function(a,b){this.detach(),this.match(a,b)?this.attach():this.handleSelection()},g.prototype.handleSelection=function(){this.isSelected()&&(this.valueElement.prop(this.getSelectionProperty(),!1),this.triggerChange())},g.prototype.isSelected=function(){return this.valueElement.is(":"+this.getSelectionProperty())},g.prototype.getSelectionProperty=function(){return this.parent.expanded?"checked":"selected"},g.prototype.triggerChange=function(){(this.parent.expanded?this.valueElement:this.parent.element).trigger("change")},g.prototype.match=function(a,b){return b(a,this)},g.prototype.attach=function(){this.element.parent().length||this.parent.element.append(this.element)},g.prototype.detach=function(){this.element.parent().length&&this.element.remove()},a.fn.collection=function(b){return this.each(function(){a(this).data("collection",new d(this,"object"==typeof b?b:{}))})},a.fn.choice=function(b){return this.each(function(){a(this).data("choice",new f(this,"object"==typeof b?b:{}))})}}(jQuery);