/*!
 * elao-form.js 0.1.5
 * http://github.com/Elao/form.js
 * Copyright 2014 Elao and other contributors; Licensed MIT
 */
!function(a,b){"function"==typeof define&&define.amd?define(["jquery"],function(c){return a.returnExportsGlobal=b(c)}):"object"==typeof exports?module.exports=b(require("jquery")):b(jQuery)}(this,function(a){function b(b){this.type=a.isArray(b)?"array":"object",this.elements="array"==this.type?[]:{},this.emitter=a(document.createElement("div")),this.onElementChange=this.onElementChange.bind(this),this.index(b)}function c(a){var b=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/;if("string"==typeof a)try{a="true"===a?!0:"false"===a?!1:"null"===a?null:+a+""===a?+a:b.test(a)?jQuery.parseJSON(a):a}catch(c){}return""===a?null:a}function d(b,c){this.element=a(b),this.replaceKey=new RegExp(this.element.data("collection"),"g"),this.currentKey=this.count(),this.allowAdd=!1,this.allowDelete=!1,this.min=!1,this.max=!1,this.limitMin=!1,this.limitMax=!1,this.htmlPrototype=null,this.addButton=null,this.items=null,this.clearData="undefined"==typeof c.clearData||c.clearData,this.onAdd="function"==typeof c.onAdd?c.onAdd:!1,this.onRemove="function"==typeof c.onRemove?c.onRemove:!1,this.parseAdd(c),this.parseDelete(c),this.parseMin(c),this.parseMax(c),this.parseItems(c),this.clearData&&this.element.removeAttr("data-collection"),this.element.data("collection",this)}function e(b,c){this.collection=b,this.element=a(c),this.deleteButton=null,this.parseDelete()}function f(b,c){this.element=a(b),this.expanded="select"!=this.element.prop("tagName").toLowerCase(),this.multiple=(this.expanded?a('input[type="checkbox"]',this.element).length:this.element.prop("multiple"))?!0:!1,this.choices=[],this.value=null,this.addOptions(this.element,"undefined"!=typeof c.data?c.data:null),this.element.on("change",this.updateValue.bind(this)),this.updateValue()}function g(b,d,e){this.element=a(b),this.parent=d,this.valueElement=this.parent.expanded?this.element.find('input[type="'+(this.parent.multiple?"checkbox":"radio")+'"]:first'):this.element,this.value=c(this.valueElement.val()),this.data="function"==typeof e?e.call(this):this.element.data()}function h(a,b,c){g.call(this,a,b,c)}function i(b,c){this.element=a(b),this.submitted=null,this.changed=[],"undefined"!=typeof c.tolerance&&(this.tolerance=c.tolerance),"undefined"!=typeof c.message&&(this.message=c.message),this.onLeave=this.onLeave.bind(this),this.onChange=this.onChange.bind(this),this.onSubmit=this.onSubmit.bind(this),this.element.on("submit",this.onSubmit),this.element.on("change",this.onChange),a(window).on("beforeunload",this.onLeave)}b.prototype.index=function(a){if("array"==this.type)for(var b=element.length,c=0;b>c;c++)this.addElement(element[c],c);else for(var d in a)this.addElement(element[element],d)},b.prototype.addElement=function(b,c){"undefined"==typeof this.elements[c]&&(this.elements[c]=a(b),this.elements[c].on("change",this.onElementChange))},b.prototype.onElementChange=function(){this.parseData(),this.emitter.trigger("change")},b.prototype.parseData=function(){var a,b="array"==this.type?[]:{};if("array"==this.type)for(var d=this.elements.length,e=0;d>e;e++)a=c(this.elements[e].val()),null!==a&&""!==a&&(b[e]=a);else for(var f in this.elements)a=c(this.elements[f].val()),null!==a&&""!==a&&(b[f]=a);this.data=b},b.prototype.on=function(a,b){this.emitter.on(a,b)},b.prototype.off=function(a,b){this.emitter.off(a,b)},d.prototype.updateLimit=function(){if(!this.items)return!1;if(this.min){this.limitMin=this.count()<=this.min;for(var a=this.items.length-1;a>=0;a--)this.items[a].toggleDelete(!this.limitMin)}this.max&&(this.limitMax=this.count()>=this.max,this.addButton.toggle(!this.limitMax))},d.prototype.count=function(){return this.element.children().length},d.prototype.canAdd=function(a){return this.allowAdd&&!this.limitMax&&(this.onAdd?this.onAdd.call(this,a):!0)},d.prototype.canRemove=function(a){return this.allowDelete&&!this.limitMin&&(this.onRemove?this.onRemove.call(this,a):!0)},d.prototype.add=function(a){"object"!=typeof a&&"CollectionItem"!==a.constructor.name&&(a=this.getPrototype()),this.canAdd(a)&&(this.items.push(a),this.element.append(a.element),this.currentKey++,this.element.trigger("collection:added",[a]))},d.prototype.remove=function(a){var b=this.items.indexOf(a);b>=0&&this.canRemove(a)&&(this.items.splice(b,1),a.element.remove(),this.element.trigger("collection:deleted",[a]))},d.prototype.getPrototype=function(){return new e(this,this.htmlPrototype.replace(this.replaceKey,this.currentKey))},d.prototype.parseAdd=function(){var b=this.element.data("collection-add");this.htmlPrototype=this.element.data("prototype"),this.element.removeAttr("data-prototype"),b&&(this.allowAdd=!0,this.addButton=a("#"+b),this.addButton.on("click",this.onAddClick.bind(this)),this.clearData&&this.element.removeAttr("data-collection-add"))},d.prototype.parseDelete=function(){this.element.data("collection-delete")&&(this.allowDelete=!0,this.clearData&&this.element.removeAttr("data-collection-delete"))},d.prototype.parseMin=function(){var a=this.element.data("collection-min");a&&(this.min=a,this.element.on("collection:deleted",this.updateLimit.bind(this)),this.clearData&&this.element.removeAttr("data-collection-min"),this.updateLimit())},d.prototype.parseMax=function(){var a=this.element.data("collection-max");a&&(this.max=a,this.element.on("collection:added",this.updateLimit.bind(this)),this.clearData&&this.element.removeAttr("data-collection-max"),this.updateLimit())},d.prototype.parseItems=function(){if(!this.items){this.items=[];for(var a=this.element.children(),b=a.length,c=0;b>c;c++)this.items.push(new e(this,a[c]));this.updateLimit()}},d.prototype.onAddClick=function(){this.add()},e.prototype.remove=function(){this.collection.remove(this)},e.prototype.toggleDelete=function(a){this.deleteButton&&this.deleteButton.toggle(a)},e.prototype.parseDelete=function(){if(null===this.deleteButton){var b=a('[data-collection-delete="'+this.element[0].id+'"]',this.element);this.collection.allowDelete&&b&&(this.deleteButton=b,this.deleteButton.on("click",this.remove.bind(this)))}},f.prototype.matchers={},f.prototype.addOptions=function(b,c){for(var d=a(b).children(),e=d.length,f=0;e>f;f++)this.addOption(d[f],c)},f.prototype.addOption=function(a,b){var c;c="optgroup"===a.tagName.toLowerCase()?new h(a,this,b):new g(a,this,b),c.isValid()&&this.choices.push(c)},f.prototype.updateValue=function(){var a=this.getValueFromSelection();this.value!=a&&(this.value=a)},f.prototype.val=function(){return this.value},f.prototype.getValueFromSelection=function(){if(this.expanded){var b=this.getSelection();if(this.multiple){for(var d=b.length,e=[],f=0;d>f;f++)e.push(b[f].value);return e}return b.value}var g=this.element.val();return this.multiple?g?a.map(g,function(a){return c(a)}):[]:c(g)},f.prototype.getSelection=function(){for(var a,b=this.choices.length,c=[],d=0;b>d;d++)if(a=this.choices[d],a.isSelected()){if(!this.multiple)return a;c.push(a)}return c},f.prototype.filter=function(a,b){var c=this.choices.length;b=this.parseMatcher(b);for(var d=0;c>d;d++)this.choices[d].filter(a,b);return this},f.prototype.reset=function(){for(var a=this.choices.length,b=0;a>b;b++)this.choices[b].attach();return this},f.prototype.addMatcher=function(a,b){return this.matchers[a]=b,this},f.prototype.matchers.valueOptionMatcher=function(b,c){return a.isArray(b)?b.indexOf(c.value)>=0:b===c.value},f.prototype.parseMatcher=function(a){var b=typeof a;return"function"==b?a:"string"==b&&"undefined"!=typeof this.matchers[a]?this.matchers[a]:this.matchers.valueOptionMatcher},g.prototype.filter=function(a,b){return this.detach(),this.match(a,b)?this.attach():this.handleSelection(),this},g.prototype.handleSelection=function(){this.isSelected()&&(this.valueElement.prop(this.getSelectionProperty(),!1),this.triggerChange())},g.prototype.isSelected=function(){return this.valueElement.is(":"+this.getSelectionProperty())},g.prototype.getSelectionProperty=function(){return this.parent.expanded?"checked":"selected"},g.prototype.triggerChange=function(){(this.parent.expanded?this.valueElement:this.parent.element).trigger("change")},g.prototype.match=function(a,b){return b(a,this)},g.prototype.attach=function(){this.isAttached()||this.parent.element.append(this.element)},g.prototype.detach=function(){this.isAttached()&&this.element.remove()},g.prototype.isAttached=function(){return this.element.parent().length},g.prototype.isValid=function(){return null!==this.value},h.prototype=Object.create(g.prototype),h.prototype.constructor=h,h.prototype.isValid=function(){return this.element.children().length>0},i.prototype.message="You have unsaved changes. Are you sure you want to quit?",i.prototype.tolerance=200,i.prototype.onLeave=function(){return this.isChanged()&&this.now()-this.submitted>this.tolerance?this.message:void 0},i.prototype.onChange=function(a){var b=a.target.defaultValue!==a.target.value;this.getLabels(a.target).toggleClass("changed",b),this.toggleChanged(b,a.target.id)},i.prototype.toggleChanged=function(a,b){var c=this.changed.indexOf(b),d=-1!==c;a&&!d?this.changed.push(b):!a&&d&&this.changed.splice(c,1)},i.prototype.isChanged=function(){return this.changed.length>0},i.prototype.onSubmit=function(){this.submitted=this.now()},i.prototype.getLabels=function(b){return"undefined"==typeof b.labels&&(b.labels=b.labels=a('label[for="'+b.id+'"]')),a(b.labels)},i.prototype.now=function(){return(new Date).getTime()},a.fn.collection=function(b){return this.each(function(){a(this).data("collection",new d(this,"object"==typeof b?b:{}))})},a.fn.choice=function(b){return this.each(function(){a(this).data("choice",new f(this,"object"==typeof b?b:{}))})},a.fn.changeConfirmation=function(){return this.each(function(){var b="object"==typeof b?b:{},c=a(this);"undefined"==typeof b.message&&(b.message=c.data("confirmation-message")),c.data("change-confirmation",new i(c,b))})}});