/*!
 * form.js 0.0.1
 * http://github.com/Elao/form.js
 * Copyright 2014 Elao and other contributors; Licensed MIT
 */

!function(a){function b(b){this.element=a(b),this.replaceKey=new RegExp(this.element.data("collection"),"g"),this.currentKey=this.count(),this.allowAdd=!1,this.allowDelete=!1,this.min=!1,this.max=!1,this.limitMin=!1,this.limitMax=!1,this.htmlPrototype=null,this.addButton=null,this.items=null,this.parseItems(),this.parseAdd(),this.parseDelete(),this.parseMin(),this.parseMax(),this.element.removeAttr("data-collection")}function c(b,c){this.collection=b,this.element=c;var d=a('[data-delete="'+this.element[0].id+'"]',c);this.collection.allowDelete&&d&&(this.deleteButton=d,this.deleteButton.on("click",this.remove.bind(this)))}b.prototype.updateLimit=function(){if(this.min){this.limitMin=this.count()<=this.min;for(var a=this.items.length-1;a>=0;a--)this.items[a].toggleDelete(!this.limitMin)}this.max&&(this.limitMax=this.count()>=this.max,this.addButton.toggle(!this.limitMax))},b.prototype.count=function(){return this.element.children().length},b.prototype.add=function(){if(this.allowAdd&&!this.limitMax){var a=this.getPrototype();this.items.push(a),this.element.append(a.element),this.currentKey++,this.element.trigger("collection:added",[a])}},b.prototype.remove=function(a){var b=this.items.indexOf(a);this.allowDelete&&!this.limitMin&&b>=0&&(this.items=this.items.slice(0,b).concat(this.items.slice(b+1)),a.element.remove(),this.element.trigger("collection:deleted",[a]))},b.prototype.getPrototype=function(){return new c(this,a(this.htmlPrototype.replace(this.replaceKey,this.currentKey)))},b.prototype.parseAdd=function(){var b=this.element.data("add");this.htmlPrototype=this.element.data("prototype"),this.element.removeAttr("data-prototype"),b&&(this.allowAdd=!0,this.addButton=a("#"+b),this.addButton.on("click",this.add.bind(this)),this.element.removeAttr("data-add"))},b.prototype.parseDelete=function(){this.element.data("delete")&&(this.allowDelete=!0,this.element.removeAttr("data-delete"))},b.prototype.parseMin=function(){var a=this.element.data("collection-min");a&&(this.min=a,this.element.on("collection:deleted",this.updateLimit.bind(this)),this.element.removeAttr("data-collection-min"),this.updateLimit())},b.prototype.parseMax=function(){var a=this.element.data("collection-max");a&&(this.max=a,this.element.on("collection:added",this.updateLimit.bind(this)),this.element.removeAttr("data-collection-max"),this.updateLimit())},b.prototype.parseItems=function(){if(!this.items){this.items=[];for(var a=this.element.children(),b=a.length,d=0;b>d;d++)this.items.push(new c(this,a[d]))}},c.prototype.remove=function(){this.collection.remove(this)},c.prototype.toggleDelete=function(a){this.deleteButton&&this.deleteButton.toggle(a)},a.fn.collection=function(a){return this.each(function(){new b(this,"object"==typeof a?a:{})})}}(jQuery);